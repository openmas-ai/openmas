# tox (https://tox.readthedocs.io/) is a tool for running tests
# in multiple virtualenvs. This configuration file will run the
# test suite on all supported python versions. To use it, "pip install tox"
# and then run "tox" from this directory.

[tox]
# Default environments to run when 'tox' is invoked without arguments.
# These cover linting, fast unit tests, and mocked integration tests.
envlist = lint, unit, integration-mock
isolated_build = True
skipsdist = False

[testenv]
# Base environment settings inherited by specific test environments
description = Base configuration for test environments
# Use Poetry for installation via 'poetry install'
# This keeps dependencies DRY by using what's defined in pyproject.toml
commands_pre =
    poetry install --with dev {env:TOX_EXTRAS:}
# Allowlist external commands used in test environments
allowlist_externals =
    pytest
    poetry
    mkdocs
    openmas
    docker
# Commands are defined in specific environments below

[testenv:lint]
description = Run linters, formatters (check mode), and type checker across the codebase
# No extra dependencies needed, just dev dependencies from poetry
# which include all the linting tools
commands =
    # Check formatting without making changes
    python -m black . --check
    python -m isort . --check
    # Run the linter on source, tests, and examples
    python -m flake8 {toxinidir}/src {toxinidir}/tests {toxinidir}/examples
    # Run the type checker on source, tests, and examples, using the config file
    python -m mypy --config-file=mypy.ini {toxinidir}/src {toxinidir}/tests {toxinidir}/examples

# The old [testenv:py310] is effectively replaced by the new [testenv:unit] and [testenv:integration-mock]
# [testenv:py310]
# description = Run the core framework unit tests and core integration tests (DEPRECATED - Use unit and integration-mock)
# deps = -e .[dev]
# allowlist_externals = pytest
# commands = pytest {toxinidir}/tests/unit {toxinidir}/tests/integration/core {posargs}

[testenv:unit]
description = Run all unit tests (fast, no external deps)
commands =
    pytest {toxinidir}/tests/unit {posargs}

[testenv:integration-mock]
description = Run integration tests using mocks (no real external services)
setenv =
    TOX_EXTRAS = --extras mcp
commands =
    pytest {toxinidir}/tests/integration/core {toxinidir}/tests/integration/mcp/mock {posargs}

[testenv:integration-real-mcp]
description = Run REAL integration tests requiring MCP services/libs
setenv =
    TOX_EXTRAS = --extras mcp
commands =
    pytest {toxinidir}/tests/integration/mcp/real {posargs}
# commands_post =
    # Example: Stop the server/container
    # pkill -f src/mcp_server_example.py
    # docker stop mcp-server-container

[testenv:integration-real-grpc]
description = Run REAL integration tests requiring gRPC services/libs
setenv =
    TOX_EXTRAS = --extras grpc
commands =
    pytest {toxinidir}/tests/integration/grpc {posargs}
# commands_post =
    # Example: Stop the gRPC service/container

[testenv:integration-real-mqtt]
description = Run REAL integration tests requiring MQTT broker
setenv =
    TOX_EXTRAS = --extras mqtt
commands =
    pytest {toxinidir}/tests/integration/mqtt {posargs}
# commands_post =
    # Example: Stop and remove the MQTT broker container
    # docker stop test-mosquitto
    # docker rm test-mosquitto

# The following integration environments will be refactored or redefined later
# to potentially use real services in CI contexts.
# [testenv:py310-mcp]
# description = Run integration tests for MCP with MCP dependencies installed (DEPRECATED/TBR)
# deps =
#     -e .[dev,mcp]
#     httpx>=0.27.0
#     aiohttp>=3.9.0
#     uvicorn>=0.30.0
#     sse-starlette>=2.3.3
# allowlist_externals = pytest
# commands = pytest -m mcp {posargs:{toxinidir}/tests/integration/mcp} -v
#
# [testenv:py310-grpc]
# description = Run integration tests for gRPC with gRPC dependencies installed (DEPRECATED/TBR)
# deps = -e .[dev,grpc]
# allowlist_externals = pytest
# commands = pytest {toxinidir}/tests/integration/grpc -m grpc {posargs}
#
# [testenv:py310-mqtt]
# description = Run integration tests for MQTT with MQTT dependencies installed (DEPRECATED/TBR)
# deps = -e .[dev,mqtt]
# allowlist_externals = pytest
# commands = pytest {toxinidir}/tests/integration/mqtt -m mqtt {posargs}

[testenv:example-00a-hello-single]
description = Run the single hello world agent example
changedir = examples/00a_hello_agent_single
setenv =
    TOX_EXTRAS = --extras all
commands =
    openmas run hello_agent_single

[testenv:coverage]
description = Run coverage report across unit and mock integration tests
setenv =
    TOX_EXTRAS = --extras all
commands =
    pytest {toxinidir}/tests/unit {toxinidir}/tests/integration/core {toxinidir}/tests/integration/mcp/mock --cov=src/openmas --cov-report=term --cov-report=xml:coverage.xml --cov-fail-under=50 {posargs}

[testenv:docs]
description = Build the documentation using MkDocs.
commands_pre =
    poetry install --with dev
    pip install mkdocs>=1.5 mkdocs-material>=9.5 mkdocstrings[python]>=0.24 pymdown-extensions>=10.0 mkdocs-include-markdown-plugin>=7.1.5
commands =
    mkdocs build --clean --strict
